# http-api

Built with [Ruby 3.4.4](https://www.ruby-lang.org/en/),
 [Gem 3.6.9](https://rubygems.org/), and [Rails 8.0.2](https://rubyonrails.org/).

## Setup

### Docker

The Dockerfile located at `http-api/Dockerfile` was generated by the `rails new`
 command and is not meant to run in a dev environment. Two modifications were
 made.

1. The API runs on TCP/8080 instead of the default TCP/80 to align with other
 examples found in this repo.
2. The `/storage` folders in `.dockerignore` were commented out so the container
  can access `storage/production*.sqlite3`.

### Credentials

Credentials are generated when a new Rails projected is created. Since the
 original credentials weren't uploaded, you will need to create a new set.

```plaintext
http-api/bin/rails credentials:edit
````

If you use VSCode, you may need to use this instead:

```plaintext
EDITOR="code --wait" http-api/bin/rails credentials:edit
```

This will create `http-api/config/master_key.yml` and open `http-api/config/credentials.yml.enc`
 in your editor. Save `credentials.yml.enc` and exit.

### Database

You'll also need to create a new database. The migration and seed files are
 included, so the three commands below should be all that is necessary.

Since we want to create a `production` database, we set `RAILS_ENV` for each 
 command, otherwise it would default to `development`.

```plaintext
# create production database
RAILS_ENV="production" http-api/bin/rails db:create

# create database schema
# see http-api/db/migrate/20250611152646_create_cities.rb
RAILS_ENV="production" http-api/bin/rails db:migrate

# seed database with data
# see http-api/db/seeds.rb
RAILS_ENV="production" http-api/bin/rails db:seed
```

## Build

Since the included Dockerfile is meant to run in production environments where
 the master key is stored in an environment variable, vault, etc. we need to set
 `RAILS_MASTER_KEY` from `http-api/config/master.key` when we compose our Docker
 containers.

```plaintext
RAILS_MASTER_KEY="$(cat http-api/config/master.key)" docker compose up --build
```

## Test

```plaintext
curl http://localhost:8080/cities

curl http://localhost:8080/cities \
   --include \
   --header "Content-Type: application/json" \
   --request "POST" \
   --data '{"name":"Boston","state":"MA","county":"Suffolk","founded":1625,"population":675647}'

curl http://localhost:8080/cities/{:id}
```

## Alloy

## Resources

- [Creating a Simple API with Ruby on Rails | Medium](https://medium.com/@handuah/creating-a-simple-api-with-ruby-on-rails-2a7020d80f71)
- [opentelemetry-ruby](https://open-telemetry.github.io/opentelemetry-ruby)
- [opentelemetry-instrumentation-rails](https://rubygems.org/gems/opentelemetry-instrumentation-rails/)
- [Ruby | OpenTelemetry](https://opentelemetry.io/docs/languages/ruby/)
- [opentelemetry/opentelemetry-ruby-contrib/.../rails | GitHub](https://github.com/open-telemetry/opentelemetry-ruby-contrib/tree/main/instrumentation/rails)
